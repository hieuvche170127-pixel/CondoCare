<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apartments - ApartmentPro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/globals.css" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-light">
<div id="sidebar-placeholder"></div>

<main style="padding-left: 260px;" class="p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3">Apartments</h1>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#apartmentModal" onclick="prepareModal('add')">+ Add Apartment</button>
    </div>

    <!-- Filter -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="input-group">
                <span class="input-group-text"><i data-lucide="search"></i></span>
                <input type="text" id="searchInput" class="form-control" placeholder="Search...">
            </div>
        </div>
        <div class="col-md-4">
            <select id="buildingFilter" class="form-select">
                <option value="all">All Buildings</option>
                <!-- JS render -->
            </select>
        </div>
        <div class="col-md-4">
            <select id="statusFilter" class="form-select">
                <option value="all">All Status</option>
                <option value="AVAILABLE">Available</option>
                <option value="OCCUPIED">Occupied</option>
                <option value="MAINTENANCE">Maintenance</option>
            </select>
        </div>
    </div>

    <!-- Summary cards -->
    <div class="row g-4 mb-4">
        <div class="col-md-3"><div class="card"><div class="card-body"><h5>Total</h5><h3 id="total-apts-summary"></h3></div></div></div>
        <div class="col-md-3"><div class="card"><div class="card-body"><h5>Occupied</h5><h3 id="occupied-summary"></h3></div></div></div>
        <div class="col-md-3"><div class="card"><div class="card-body"><h5>Available</h5><h3 id="available-summary"></h3></div></div></div>
        <div class="col-md-3"><div class="card"><div class="card-body"><h5>Maintenance</h5><h3 id="maint-summary"></h3></div></div></div>
    </div>

    <div class="card">
        <div class="card-body">
            <table class="table table-hover" id="apartmentsTable">
                <thead>
                <tr>
                    <th>Unit</th>
                    <th>Building</th>
                    <th>Details</th>
                    <th>Rent</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- Modal for Add/Edit -->
    <div class="modal fade" id="apartmentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Add New Apartment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="apartmentForm">
                        <input type="hidden" id="aptId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="buildingId" class="form-label">Building</label>
                                <select id="buildingId" class="form-select" required>
                                    <!-- JS render options -->
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="unitNumber" class="form-label">Unit Number</label>
                                <input type="text" id="unitNumber" class="form-control" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="floor" class="form-label">Floor</label>
                                <input type="number" id="floor" class="form-control" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="area" class="form-label">Area (m²)</label>
                                <input type="number" id="area" class="form-control" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="bedrooms" class="form-label">Bedrooms</label>
                                <input type="number" id="bedrooms" class="form-control" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="bathrooms" class="form-label">Bathrooms</label>
                                <input type="number" id="bathrooms" class="form-control" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="rentPrice" class="form-label">Rent Price (VND)</label>
                                <input type="number" id="rentPrice" class="form-control" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="status" class="form-label">Status</label>
                                <select id="status" class="form-select" required>
                                    <option value="AVAILABLE">Available</option>
                                    <option value="OCCUPIED">Occupied</option>
                                    <option value="MAINTENANCE">Maintenance</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea id="description" class="form-control" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveApartment()">Save</button>
                </div>
            </div>
        </div>
    </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="../data.js"></script>
<script>
    lucide.createIcons();
    fetch('../sidebar.html').then(r => r.text()).then(html => document.getElementById('sidebar-placeholder').innerHTML = html);

    let currentEditId = null;

    function prepareModal(mode, apt = null) {
      document.getElementById('modalTitle').textContent = mode === 'add' ? 'Add New Apartment' : 'Edit Apartment';
      currentEditId = mode === 'add' ? null : apt.id;
      document.getElementById('buildingId').value = apt ? apt.buildingId : '';
      document.getElementById('unitNumber').value = apt ? apt.unitNumber : '';
      document.getElementById('floor').value = apt ? apt.floor : '';
      document.getElementById('area').value = apt ? apt.area : '';
      document.getElementById('bedrooms').value = apt ? apt.bedrooms : '';
      document.getElementById('bathrooms').value = apt ? apt.bathrooms : '';
      document.getElementById('rentPrice').value = apt ? apt.rentPrice : '';
      document.getElementById('status').value = apt ? apt.status : 'AVAILABLE';
      document.getElementById('description').value = apt ? apt.description : '';
    }

    function saveApartment() {
      const formData = {
        buildingId: document.getElementById('buildingId').value,
        unitNumber: document.getElementById('unitNumber').value,
        floor: parseInt(document.getElementById('floor').value),
        area: parseInt(document.getElementById('area').value),
        bedrooms: parseInt(document.getElementById('bedrooms').value),
        bathrooms: parseInt(document.getElementById('bathrooms').value),
        rentPrice: parseInt(document.getElementById('rentPrice').value),
        status: document.getElementById('status').value,
        description: document.getElementById('description').value
      };
      if (currentEditId) {
        const index = apartments.findIndex(a => a.id === currentEditId);
        apartments[index] = { ...apartments[index], ...formData };
      } else {
        formData.id = 'A' + Date.now().toString().slice(-3);
        formData.createdAt = new Date().toISOString().slice(0,10);
        formData.updatedAt = formData.createdAt;
        apartments.push(formData);
      }
      saveData('apartments', apartments);
      renderApartments();
      renderSummary();
      bootstrap.Modal.getInstance(document.getElementById('apartmentModal')).hide();
    }

    function deleteApartment(id) {
      if (confirm('Xác nhận xóa?')) {
        apartments = apartments.filter(a => a.id !== id);
        saveData('apartments', apartments);
        renderApartments();
        renderSummary();
      }
    }

    function renderApartments(filter = {}) {
      const tbody = document.querySelector('#apartmentsTable tbody');
      tbody.innerHTML = '';
      let filtered = apartments;
      const search = document.getElementById('searchInput').value.toLowerCase();
      const buildingFilter = document.getElementById('buildingFilter').value;
      const statusFilter = document.getElementById('statusFilter').value;

      filtered = filtered.filter(a => {
        return (search === '' || a.unitNumber.toLowerCase().includes(search) || getBuildingById(a.buildingId)?.name.toLowerCase().includes(search));
        && (buildingFilter === 'all' || a.buildingId === buildingFilter);
        && (statusFilter === 'all' || a.status === statusFilter);
      });

      filtered.forEach(a => {
        const building = getBuildingById(a.buildingId);
        const row = `
          <tr>
            <td>${a.unitNumber}</td>
            <td>${building ? building.name : 'N/A'}</td>
            <td>${a.area} m², ${a.bedrooms} bed, ${a.bathrooms} bath</td>
            <td>${formatCurrency(a.rentPrice)}</td>
            <td>${getStatusBadge(a.status)}</td>
            <td>
              <a href="detail.html?id=${a.id}" class="btn btn-sm btn-outline-info me-1">View</a>
              <button class="btn btn-sm btn-outline-warning me-1" data-bs-toggle="modal" data-bs-target="#apartmentModal" onclick="prepareModal('edit', apartments.find(a => a.id === '${a.id}'))">Edit</button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteApartment('${a.id}')">Delete</button>
            </td>
          </tr>
        `;
        tbody.innerHTML += row;
      });
    }

    function renderSummary() {
      document.getElementById('total-apts-summary').textContent = apartments.length;
      document.getElementById('occupied-summary').textContent = apartments.filter(a => a.status === 'OCCUPIED').length;
      document.getElementById('available-summary').textContent = apartments.filter(a => a.status === 'AVAILABLE').length;
      document.getElementById('maint-summary').textContent = apartments.filter(a => a.status === 'MAINTENANCE').length;
    }

    function renderFilters() {
      const buildingSelect = document.getElementById('buildingId');
      const filterSelect = document.getElementById('buildingFilter');
      buildings.forEach(b => {
        const option = `<option value="${b.id}">${b.name}</option>`;
        buildingSelect.innerHTML += option;
        filterSelect.innerHTML += option;
      });
    }

    renderFilters();
    renderApartments();
    renderSummary();

    document.getElementById('searchInput').addEventListener('input', () => renderApartments());
    document.getElementById('buildingFilter').addEventListener('change', () => renderApartments());
    document.getElementById('statusFilter').addEventListener('change', () => renderApartments());
</script>
</body>
</html>